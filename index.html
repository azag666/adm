<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Cockpit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0d0f18; --bg-medium: #151825; --bg-light: #212534;
            --border-color: rgba(128, 137, 163, 0.2); --text-primary: #e1e1e6; --text-secondary: #a8a8b3;
            --accent-glow: #00f2ea; --accent-glow-transparent: rgba(0, 242, 234, 0.1);
            --accent-purple: #8257e5; --accent-purple-transparent: rgba(130, 87, 229, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-medium); }
        ::-webkit-scrollbar-thumb { background: #3c4157; border-radius: 4px; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            font-size: 14px;
            background-image: linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(to right, var(--border-color) 1px, var(--bg-dark) 1px);
            background-size: 20px 20px;
        }
        #sidebar {
            width: 240px; background-color: var(--bg-medium); padding: 2rem 1rem;
            height: 100vh; position: fixed; border-right: 1px solid var(--border-color); z-index: 10;
        }
        #sidebar h1 { font-family: 'Roboto Mono', monospace; font-size: 1.5rem; font-weight: 500; margin-bottom: 2.5rem; padding: 0 0.5rem; text-shadow: 0 0 5px var(--accent-glow); }
        .nav-link { display: flex; align-items: center; padding: 0.9rem 1rem; border-radius: 8px; color: var(--text-secondary); text-decoration: none; margin-bottom: 0.5rem; font-weight: 500; transition: all 0.2s ease-in-out; border-left: 3px solid transparent; cursor: pointer; }
        .nav-link i { width: 24px; text-align: center; margin-right: 1rem; }
        .nav-link:hover { background-color: var(--accent-glow-transparent); color: var(--text-primary); }
        .nav-link.is-active { background-color: var(--accent-glow-transparent); color: var(--accent-glow); border-left: 3px solid var(--accent-glow); }
        
        #main-content { margin-left: 240px; width: calc(100% - 240px); padding: 2rem 3rem; animation: fadeIn 0.5s ease-in-out; }
        .content-header h2 { font-size: 2rem; font-weight: 700; }
        
        .section-content { display: none; }
        .section-content.is-active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: rgba(21, 24, 37, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            height: 100%;
        }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-top: 2rem; }
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem; }
        .metric-card .heading { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .metric-card .title { font-size: 2.2rem; font-weight: 700; font-family: 'Roboto Mono', monospace; color: var(--text-primary); }
        .metric-card.profit .title { color: var(--accent-glow); text-shadow: 0 0 8px var(--accent-glow); }

        .leaderboard-item { display: flex; align-items: center; margin-bottom: 1rem; }
        .leaderboard-item .rank { font-size: 1.2rem; font-weight: 700; color: var(--text-secondary); width: 30px; }
        .leaderboard-item .info { flex-grow: 1; }
        .leaderboard-item .name { font-weight: 600; }
        .leaderboard-item .revenue { font-family: 'Roboto Mono', monospace; color: var(--accent-glow); }
        .leaderboard-item.gold { color: #ffd700; }
        .leaderboard-item.silver { color: #c0c0c0; }
        .leaderboard-item.bronze { color: #cd7f32; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr:hover { background-color: var(--bg-light); }
        
        .progress-bar { width: 100%; background-color: var(--bg-dark); border-radius: 4px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-glow)); border-radius: 4px; }
        
        .activity-feed .item { display: flex; padding: 1rem; border-bottom: 1px solid var(--border-color); animation: slideInUp 0.5s forwards; }
        .activity-feed .icon { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; margin-right: 1rem; }
        .activity-feed .item.sale .icon { background-color: var(--accent-glow-transparent); color: var(--accent-glow); }
        .activity-feed .item.user .icon { background-color: var(--accent-purple-transparent); color: var(--accent-purple); }
        .activity-feed .timestamp { font-size: 0.8rem; color: var(--text-secondary); margin-left: auto; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .tag { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .tag.is-success { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
        .tag.is-danger { background-color: rgba(220, 53, 69, 0.2); color: #dc3545; }
    </style>
</head>
<body>
    <nav id="sidebar">
        <h1>[Admin]</h1>
        <a class="nav-link is-active" data-tab="dashboard"><i class="fas fa-satellite-dish"></i> Dashboard</a>
        <a class="nav-link" data-tab="sellers"><i class="fas fa-users-cog"></i> Vendedores</a>
        <a class="nav-link" data-tab="ranking"><i class="fas fa-trophy"></i> Ranking</a>
    </nav>

    <main id="main-content">
        <section id="dashboard" class="section-content is-active">
            <div class="content-header">
                <h2>Cockpit de Controle</h2>
            </div>
            <div class="metrics-grid">
                <div class="card metric-card"><p class="heading">Faturamento Total</p><p id="metric-revenue" class="title">R$ 0.00</p></div>
                <div class="card metric-card"><p class="heading">Vendedores Ativos</p><p id="metric-sellers" class="title">0</p></div>
                <div class="card metric-card"><p class="heading">Vendas Pagas</p><p id="metric-sales" class="title">0</p></div>
                <div class="card metric-card profit"><p class="heading">Seu Lucro (Estimado)</p><p id="metric-profit" class="title">R$ 0.00</p></div>
            </div>
            <div class="dashboard-grid">
                <div class="card">
                    <canvas id="revenue-chart"></canvas>
                </div>
                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1.5rem;">Leaderboard (Top 5)</h3>
                    <div id="leaderboard-body"></div>
                </div>
            </div>
        </section>

        <section id="sellers" class="section-content">
             <div class="content-header"><h2>Gerenciar Vendedores</h2></div>
             <table>
                <thead>
                    <tr><th>Vendedor</th><th>Nível</th><th>Progresso</th><th>Faturamento</th><th>Status</th></tr>
                </thead>
                <tbody id="sellers-body"></tbody>
            </table>
        </section>
        
        <section id="ranking" class="section-content">
             <div class="content-header"><h2>Ranking Completo</h2></div>
             <table>
                <thead>
                    <tr><th>#</th><th>Nome</th><th>Email</th><th>Vendas Pagas</th><th>Faturamento Total</th></tr>
                </thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://hottrack.vercel.app'; // CONFIRME SE ESTA É A URL CORRETA DO SEU BACKEND
            let ADMIN_API_KEY = sessionStorage.getItem('ADMIN_API_KEY');
            let revenueChart = null;

            // Função para buscar dados da API
            const apiFetch = async (endpoint, options = {}) => {
                if (!ADMIN_API_KEY) {
                    ADMIN_API_KEY = prompt('Por favor, insira sua Chave de API de Administrador:');
                    if (!ADMIN_API_KEY) throw new Error('Chave de API não fornecida.');
                    sessionStorage.setItem('ADMIN_API_KEY', ADMIN_API_KEY);
                }
                const headers = { 'Content-Type': 'application/json', 'x-admin-api-key': ADMIN_API_KEY, ...options.headers, };
                const response = await fetch(`${API_BASE_URL}/api/admin${endpoint}`, { ...options, headers });
                if (response.status === 403) {
                    sessionStorage.removeItem('ADMIN_API_KEY');
                    throw new Error('Acesso negado. Chave de API inválida.');
                }
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Ocorreu um erro na API.' }));
                    throw new Error(error.message);
                }
                return response.json();
            };
            
            // Função para animar os números do dashboard
            const animateValue = (elementId, start, end, duration, isCurrency = false) => {
                const obj = document.getElementById(elementId);
                if (!obj) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const currentValue = progress * (end - start) + start;
                    if (isCurrency) {
                         obj.innerHTML = `R$ ${currentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else {
                        obj.innerHTML = Math.floor(currentValue).toLocaleString('pt-BR');
                    }
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            };

            const getLevel = (revenue) => {
                revenue = parseFloat(revenue);
                if (revenue < 1000) return { name: "Bronze", progress: (revenue / 1000) * 100, color: "#cd7f32" };
                if (revenue < 5000) return { name: "Prata", progress: ((revenue-1000) / 4000) * 100, color: "#c0c0c0" };
                if (revenue < 15000) return { name: "Ouro", progress: ((revenue-5000) / 10000) * 100, color: "#ffd700" };
                return { name: "Platina", progress: 100, color: "#e5e4e2" };
            };

            const loadDashboard = async () => {
                try {
                    const data = await apiFetch('/dashboard');
                    animateValue("metric-revenue", 0, parseFloat(data.total_revenue), 1500, true);
                    animateValue("metric-sellers", 0, data.total_sellers, 1500);
                    animateValue("metric-sales", 0, data.total_paid_transactions, 1500);
                    animateValue("metric-profit", 0, parseFloat(data.saas_profit), 1500, true);
                    
                    const rankingData = await apiFetch('/ranking');
                    renderLeaderboard(rankingData.slice(0, 5));
                    renderChart();
                } catch (error) {
                    alert('Não foi possível carregar os dados do dashboard: ' + error.message);
                }
            };
            
            const renderLeaderboard = (data) => {
                document.getElementById('leaderboard-body').innerHTML = data.map((seller, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return `
                    <div class="leaderboard-item ${rankClass}">
                        <div class="rank">#${i + 1}</div>
                        <div class="info">
                            <div class="name">${seller.name}</div>
                            <div class="revenue">R$ ${parseFloat(seller.total_revenue).toFixed(2)}</div>
                        </div>
                    </div>`
                }).join('');
            };

             const loadSellers = async () => {
                const data = await apiFetch('/sellers');
                document.getElementById('sellers-body').innerHTML = data.map(seller => {
                    const level = getLevel(seller.total_revenue);
                    return `
                    <tr>
                        <td>
                            <strong style="color: ${level.color};">${seller.name}</strong><br>
                            <small>${seller.email}</small>
                        </td>
                        <td><strong style="color: ${level.color};">${level.name}</strong></td>
                        <td><div class="progress-bar"><div class="progress-bar-inner" style="width: ${level.progress}%;"></div></div></td>
                        <td>R$ ${parseFloat(seller.total_revenue).toFixed(2)}</td>
                        <td><span class="tag ${seller.is_active ? 'is-success' : 'is-danger'}">${seller.is_active ? 'Ativo' : 'Bloqueado'}</span></td>
                    </tr>`
                }).join('');
            };
            
            const loadRanking = async () => {
                const data = await apiFetch('/ranking');
                document.getElementById('ranking-body').innerHTML = data.map((seller, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${seller.name}</td>
                        <td>${seller.email}</td>
                        <td>${seller.total_sales}</td>
                        <td>R$ ${parseFloat(seller.total_revenue).toFixed(2)}</td>
                    </tr>`).join('');
            };

            const renderChart = () => {
                // Mock data para o gráfico, já que não temos histórico diário na API ainda
                const labels = ['D-6', 'D-5', 'D-4', 'D-3', 'D-2', 'Ontem', 'Hoje'];
                const chartData = Array.from({length: 7}, () => Math.random() * 5000);

                const ctx = document.getElementById('revenue-chart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 242, 234, 0.4)');
                gradient.addColorStop(1, 'rgba(0, 242, 234, 0)');

                if (revenueChart) revenueChart.destroy();
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{
                        label: 'Faturamento', data: chartData, backgroundColor: gradient,
                        borderColor: 'rgba(0, 242, 234, 1)', borderWidth: 2,
                        pointBackgroundColor: 'rgba(0, 242, 234, 1)', pointRadius: 4,
                        tension: 0.4, fill: true
                    }]},
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(128, 137, 163, 0.1)' }, ticks: { color: 'rgba(128, 137, 163, 0.8)' } },
                            x: { grid: { display: false }, ticks: { color: 'rgba(128, 137, 163, 0.8)' } }
                        }
                    }
                });
            };

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section-content');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if(link.classList.contains('is-active')) return;
                    navLinks.forEach(item => item.classList.remove('is-active'));
                    sections.forEach(section => section.classList.remove('is-active'));
                    link.classList.add('is-active');
                    document.getElementById(link.dataset.tab).classList.add('is-active');

                    switch(link.dataset.tab) {
                        case 'dashboard': loadDashboard(); break;
                        case 'sellers': loadSellers(); break;
                        case 'ranking': loadRanking(); break;
                    }
                });
            });

            loadDashboard();
        });
    </script>
</body>
</html>
